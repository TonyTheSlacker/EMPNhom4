using Microsoft.Reporting.WinForms;
using System;
using System.Linq;
using System.Windows.Forms;

namespace QLNHANVIENFULL {
    public partial class ReportForm : Form {
        EmployeeDataContext db = new EmployeeDataContext();
        public ReportForm() {
            InitializeComponent();
        }

        private void ReportForm_Load(object sender, EventArgs e) {
            cbbGender.Items.Clear();
            cbbGender.Items.AddRange(new object[] { "All", "Male", "Female" });
            cbbGender.SelectedIndex =0;
            rdoAllDay.Checked = true;

            // Populate names and IDs
            var employees = db.Employees.Select(emp => new { emp.EmpID, emp.EmpName }).ToList();
            cbbFullName.Items.Clear();
            cbbEmpID.Items.Clear();
            cbbFullName.Items.Add("All");
            cbbEmpID.Items.Add("All");
            foreach (var emp in employees) {
                cbbFullName.Items.Add(emp.EmpName);
                cbbEmpID.Items.Add(emp.EmpID.ToString());
            }
            cbbFullName.SelectedIndex =0;
            cbbEmpID.SelectedIndex =0;
        }

        private void btnExport_Click(object sender, EventArgs e) {
            reportViewer1.LocalReport.ReportEmbeddedResource = "QLNHANVIENFULL.Report1.rdlc";
            ReportParameter rp = new ReportParameter("DateTimeNowRp", DateTime.Now.ToString());
            reportViewer1.LocalReport.SetParameters(rp);
            var reportDataSource = new ReportDataSource { Name = "Salary" };

            string gender = cbbGender.Text;
            string nameSelected = cbbFullName.Text;
            string idSelected = cbbEmpID.Text;

            var baseQuery = db.Salaries.AsQueryable();
            if (gender != "All") baseQuery = baseQuery.Where(m => m.Employee.EmpGen == gender);
            if (nameSelected != "All") baseQuery = baseQuery.Where(m => m.EmployeeName == nameSelected);
            if (idSelected != "All") baseQuery = baseQuery.Where(m => m.Employee.EmpID.ToString() == idSelected);

            if (rdoFromto.Checked) {
                int NgayFrom = dtpkFrom.Value.Day;
                int ThangFrom = dtpkFrom.Value.Month;
                int NamFrom = dtpkFrom.Value.Year;
                int NgayTo = dtpkTo.Value.Day;
                int ThangTo = dtpkTo.Value.Month;
                int NamTo = dtpkTo.Value.Year;
                baseQuery = baseQuery
                    .Where(m => m.From.Day >= NgayFrom)
                    .Where(m => m.From.Month >= ThangFrom)
                    .Where(m => m.From.Year >= NamFrom)
                    .Where(m => m.To.Day <= NgayTo)
                    .Where(m => m.To.Month <= ThangTo)
                    .Where(m => m.To.Year <= NamTo);
            }

            reportDataSource.Value = baseQuery.Select(m => new { m.EmployeeName, m.Employee.EmpSal, m.Period, m.From, m.To, m.totalsal, m.Paydate });
            reportViewer1.LocalReport.DataSources.Clear();
            reportViewer1.LocalReport.DataSources.Add(reportDataSource);
            reportViewer1.RefreshReport();
        }

        private void rdoAllDay_CheckedChanged(object sender, EventArgs e) {
            bool enableRange = !rdoAllDay.Checked;
            dtpkFrom.Enabled = enableRange;
            dtpkTo.Enabled = enableRange;
        }
        private void label3_Click(object sender, EventArgs e) { }
        private void cbbFullName_SelectedIndexChanged(object sender, EventArgs e) { }
        private void cbbEmpID_SelectedIndexChanged(object sender, EventArgs e) { }
    }
}
