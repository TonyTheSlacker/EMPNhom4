using System;
using System.Linq;
using System.Runtime.InteropServices;
using System.Windows.Forms;

namespace QLNHANVIENFULL {
    public partial class UpdateSalaryForm : Form {

        public const int WM_NCLBUTTONDOWN = 0xA1;
        public const int HT_CAPTION = 0x2;

        [DllImportAttribute("user32.dll")]
        public static extern int SendMessage(IntPtr hWnd, int Msg, int wParam, int lParam);
        [DllImportAttribute("user32.dll")]
        public static extern bool ReleaseCapture();

        Salary salary = null; // entity originally passed from SalaryForm context
        public UpdateSalaryForm(Salary sal = null) {
            salary = sal;
            InitializeComponent();
        }
        EmployeeDataContext db = new EmployeeDataContext();

        private int CalculateMonths(DateTime from, DateTime to) {
            from = from.Date; to = to.Date;
            if (to < from) return 0;
            int months = (to.Year - from.Year) * 12 + (to.Month - from.Month);
            if (to.Day < from.Day) months--; // last month incomplete
            if (months < 1) months = 1; // treat same/partial month as1
            return months;
        }

        private long ComputeTotalByPaidDaysLong(int monthlySalary, DateTime from, DateTime to, int unpaidDays) {
            var f = from.Date; var t = to.Date; if (t < f || monthlySalary <= 0) return 0L;
            int months = CalculateMonths(f, t); if (months <= 0) return 0L;
            long gross = (long)months * (long)monthlySalary;
            int rangeDays = (t - f).Days + 1; int ud = Math.Min(Math.Max(unpaidDays, 0), Math.Max(rangeDays, 0));
            decimal dailyRate = Math.Ceiling((decimal)monthlySalary / 30m);
            decimal deduction = ud * dailyRate;
            decimal net = ((decimal)gross) - deduction; if (net < 0) net = 0m;
            if (net > long.MaxValue) return long.MaxValue; return (long)net;
        }

        private void LoadEmployee() {
            // Bind by Employee ID so user can search/type IDs
            cbbEmployee.Items.Clear();
            cbbEmployee.DataSource = db.Employees;
            cbbEmployee.DisplayMember = "EmpId"; // visible text will be the ID
            cbbEmployee.ValueMember = "EmpId"; // selected value is also the ID
            cbbEmployee.AutoCompleteMode = AutoCompleteMode.SuggestAppend;
            cbbEmployee.AutoCompleteSource = AutoCompleteSource.ListItems;

            // Bind fullname list for optional selection
            cbbEmpName.Items.Clear();
            cbbEmpName.DataSource = db.Employees;
            cbbEmpName.DisplayMember = "EmpName";
            cbbEmpName.ValueMember = "EmpId"; // same value (EmpId) so both stay in sync
            cbbEmpName.AutoCompleteMode = AutoCompleteMode.SuggestAppend;
            cbbEmpName.AutoCompleteSource = AutoCompleteSource.ListItems;

            // Sync selections both ways
            cbbEmployee.SelectedIndexChanged -= cbbEmployee_SelectedIndexChanged;
            cbbEmpName.SelectedIndexChanged -= cbbEmpName_SelectedIndexChanged;
            cbbEmployee.SelectedIndexChanged += cbbEmployee_SelectedIndexChanged;
            cbbEmpName.SelectedIndexChanged += cbbEmpName_SelectedIndexChanged;
        }

        private void ReloadSalaryFromDb() {
            if (salary == null) return;
            // Use local context to get fresh values (avoid stale entity from other DataContext)
            var fresh = db.Salaries.SingleOrDefault(s => s.Scode == salary.Scode);
            if (fresh != null) salary = fresh; // replace reference
        }

        private void cbbEmployee_SelectedIndexChanged(object sender, EventArgs e) {
            if (cbbEmployee.SelectedValue != null && cbbEmpName.ValueMember == "EmpId") {
                cbbEmpName.SelectedValue = cbbEmployee.SelectedValue;
            }
        }
        private void cbbEmpName_SelectedIndexChanged(object sender, EventArgs e) {
            if (cbbEmpName.SelectedValue != null && cbbEmployee.ValueMember == "EmpId") {
                cbbEmployee.SelectedValue = cbbEmpName.SelectedValue;
            }
        }

        private void ptbClose_Click(object sender, EventArgs e) {
            this.Dispose();
        }

        private void UpdateSalaryForm_Load(object sender, EventArgs e) {
            LoadEmployee();
            ReloadSalaryFromDb(); // ensure up-to-date values
            if (salary != null) {
                txtSalary.Text = CurrencyFormatter.Format(salary.Salary1); // formatted display
                try { cbbEmployee.SelectedValue = salary.EmployeeID; cbbEmpName.SelectedValue = salary.EmployeeID; } catch { }
                // Assign DateTimePicker Value (not Text) to avoid formatting issues
                dtpkFrom.Value = salary.From;
                dtpkTo.Value = salary.To;
                dtpkPayDate.Value = salary.Paydate;

                // NEW: load unpaid days
                numUnpaidDays.Value = salary.UnpaidDays.GetValueOrDefault(0);
            }
        }

        private void btnAdd_Click(object sender, EventArgs e) {
            if (string.IsNullOrEmpty(cbbEmployee.Text) || string.IsNullOrEmpty(txtSalary.Text) || string.IsNullOrEmpty(cbbEmployee.Text)) {
                MessageBox.Show("Miss data", "Notification", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int empId = int.Parse(cbbEmployee.SelectedValue.ToString());
            Salary sal = new Salary();
            Employee epl = db.Employees.SingleOrDefault(emp => emp.EmpID == empId);
            sal.EmployeeID = empId;
            sal.EmployeeName = epl != null ? epl.EmpName : string.Empty;
            sal.From = dtpkFrom.Value;
            sal.To = dtpkTo.Value;
            sal.Period = CalculateMonths(sal.From, sal.To);
            sal.Paydate = dtpkPayDate.Value;
            int parsedSal;
            if (int.TryParse(txtSalary.Text, out parsedSal)) sal.Salary1 = parsedSal; else if (epl != null) sal.Salary1 = epl.EmpSal; else sal.Salary1 = 0;
            sal.UnpaidDays = (int)numUnpaidDays.Value;
            // store clamped int, display long elsewhere
            sal.totalsal = ComputeTotalByPaidDaysLong(sal.Salary1, sal.From, sal.To, sal.UnpaidDays.GetValueOrDefault(0));
            db.Salaries.InsertOnSubmit(sal);
            db.SubmitChanges();
            MessageBox.Show("Inserted Sucessfully", "Notification", MessageBoxButtons.OK, MessageBoxIcon.Information);
            this.Dispose();

        }

        private void btnUpdate_Click(object sender, EventArgs e) {
            if (salary == null) return;
            var tmp = db.Salaries.SingleOrDefault(m => m.Scode == salary.Scode);
            if (tmp == null) return;
            int empId = int.Parse(cbbEmployee.SelectedValue.ToString());
            tmp.EmployeeID = empId;
            tmp.Salary1 = CurrencyFormatter.ParseToInt(txtSalary.Text); if (tmp.Salary1 <= 0) { var epl = db.Employees.SingleOrDefault(emp => emp.EmpID == empId); if (epl != null) tmp.Salary1 = epl.EmpSal; }
            var epl2 = db.Employees.SingleOrDefault(emp => emp.EmpID == empId); tmp.EmployeeName = epl2 != null ? epl2.EmpName : string.Empty;
            tmp.From = dtpkFrom.Value; tmp.To = dtpkTo.Value; tmp.Paydate = dtpkPayDate.Value; tmp.Period = CalculateMonths(tmp.From, tmp.To);
            tmp.UnpaidDays = (int)numUnpaidDays.Value;
            tmp.totalsal = ComputeTotalByPaidDaysLong(tmp.Salary1, tmp.From, tmp.To, tmp.UnpaidDays.GetValueOrDefault(0));
            db.SubmitChanges();
            MessageBox.Show("Updated Sucessfully", "Notification", MessageBoxButtons.OK, MessageBoxIcon.Information);
            this.Dispose();
        }

        private void pnltop_MouseDown(object sender, MouseEventArgs e) {
            if (e.Button == MouseButtons.Left) {
                ReleaseCapture();
                SendMessage(Handle, WM_NCLBUTTONDOWN, HT_CAPTION, 0);
            }
        }
        private void label4_Click(object sender, EventArgs e) { }
        private void dtpkPayDate_ValueChanged(object sender, EventArgs e) { }
    }
}
