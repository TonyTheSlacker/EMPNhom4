using Microsoft.Reporting.WinForms;
using System;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Windows.Forms;
using System.Globalization; // added for Vietnamese currency formatting

namespace EmployeeManagementSystem {
    public partial class ReportForm : Form {
        readonly EmployeeDataContext db = new EmployeeDataContext();
        public ReportForm() {
            InitializeComponent();
        }

        // Helper to format number like 123.000.000 VNĐ (Vietnamese thousands separator '.')
        private string FormatVnd(long amount) {
            if (amount < 0) amount = 0; // no negatives in this context
            return amount.ToString("N0", new CultureInfo("vi-VN")) + " VNĐ"; // N0 uses grouping and no decimals
        }
        private string FormatVnd(int amount) { return FormatVnd((long)amount); }

        private void ReportForm_Load(object sender, EventArgs e) {
            cbbGender.Items.Clear();
            cbbGender.Items.AddRange(new object[] { "All", "Male", "Female" });
            cbbGender.SelectedIndex = 0;
            rdoAllDay.Checked = true;

            // Populate names and IDs
            var employees = db.Employees.Select(emp => new { emp.EmpID, emp.EmpName }).ToList();
            cbbFullName.Items.Clear();
            cbbEmpID.Items.Clear();
            cbbFullName.Items.Add("All");
            cbbEmpID.Items.Add("All");
            foreach (var emp in employees)
            {
                cbbFullName.Items.Add(emp.EmpName);
                cbbEmpID.Items.Add(emp.EmpID.ToString());
            }
            cbbFullName.SelectedIndex = 0;
            cbbEmpID.SelectedIndex = 0;
        }

        private string ResolveReportDefinition(string fileName, out bool embedded) {
            embedded = false;
            // Try embedded resource first
            var asm = Assembly.GetExecutingAssembly();
            var resourceName = asm.GetManifestResourceNames().FirstOrDefault(n => n.EndsWith(fileName, StringComparison.OrdinalIgnoreCase));
            if (resourceName != null)
            {
                embedded = true;
                return resourceName;
            }

            // Physical path search (output dir + parent levels + project folder)
            string[] roots = new[] {
                Application.StartupPath,
                Environment.CurrentDirectory
            };
            foreach (var root in roots)
            {
                var p = Path.Combine(root, fileName);
                if (File.Exists(p))
                    return p;
            }
            var dir = new DirectoryInfo(Application.StartupPath);
            for (int i = 0; i < 6 && dir != null; i++)
            {
                var candidate = Path.Combine(dir.FullName, fileName);
                if (File.Exists(candidate))
                    return candidate;
                // project folder name might be the solution/project namespace - ensure we search for EmployeeManagementSystem
                var projCandidate = Path.Combine(dir.FullName, "EmployeeManagementSystem", fileName);
                if (File.Exists(projCandidate))
                    return projCandidate;
                dir = dir.Parent;
            }
            return null;
        }

        private void btnExport_Click(object sender, EventArgs e) {
            try
            {
                // Prepare the report content
                reportViewer1.Reset();
                reportViewer1.ProcessingMode = ProcessingMode.Local;

                bool embedded;
                var reportDef = ResolveReportDefinition("Report1.rdlc", out embedded);
                if (reportDef == null)
                {
                    throw new InvalidOperationException("Cannot locate Report1.rdlc. Set its Build Action to 'Embedded Resource' OR Copy to Output Directory.");
                }
                try
                {
                    if (embedded)
                    {
                        using (var s = Assembly.GetExecutingAssembly().GetManifestResourceStream(reportDef))
                        {
                            reportViewer1.LocalReport.LoadReportDefinition(s);
                        }
                    }
                    else
                    {
                        // Read file, normalize names and schema to avoid "definition is invalid" issues
                        string text = File.ReadAllText(reportDef);
                        // Replace old project names
                        text = text.Replace("QLNHANVIEN", "EmployeeManagementSystem");
                        // Ensure dataset reference uses consistent DataSource name
                        text = text.Replace("EmployeeManagementSystemDataSetDataSet", "EmployeeManagementSystemDataSet");
                        // Some ReportViewer versions expect an older namespace - replace if present
                        if (text.Contains("http://schemas.microsoft.com/sqlserver/reporting/2016/01/reportdefinition"))
                        {
                            text = text.Replace("http://schemas.microsoft.com/sqlserver/reporting/2016/01/reportdefinition", "http://schemas.microsoft.com/sqlserver/reporting/2010/01/reportdefinition");
                        }
                        // Load modified definition from memory stream
                        using (var ms = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(text)))
                        {
                            reportViewer1.LocalReport.LoadReportDefinition(ms);
                        }
                    }
                }
                catch (Exception loadEx)
                {
                    throw new InvalidOperationException("Failed to load RDLC definition: " + loadEx.Message, loadEx);
                }

                string gender = cbbGender.Text;
                string nameSelected = cbbFullName.Text;
                string idSelected = cbbEmpID.Text;

                var baseQuery = db.Salaries.AsQueryable();
                if (gender != "All")
                    baseQuery = baseQuery.Where(m => m.Employee.EmpGen == gender);
                if (nameSelected != "All")
                    baseQuery = baseQuery.Where(m => m.EmployeeName == nameSelected);
                if (idSelected != "All")
                    baseQuery = baseQuery.Where(m => m.Employee.EmpID.ToString() == idSelected);
                if (rdoFromto.Checked)
                {
                    DateTime fromDate = dtpkFrom.Value.Date;
                    DateTime toDate = dtpkTo.Value.Date;
                    baseQuery = baseQuery.Where(m => m.From >= fromDate && m.To <= toDate);
                }

                var projected = baseQuery.OrderBy(m => m.Employee.EmpID).Select(m => new
                {
                    EmployeeID = m.Employee.EmpID,
                    m.Scode,
                    m.EmployeeName,
                    // Format monthly salary in VND style
                    Salary = FormatVnd(m.Salary1),
                    Period = m.Period,
                    m.From,
                    m.To,
                    m.Paydate,
                    // Format total salary (net) also in VND style; guard for nullable
                    totalsal = FormatVnd(m.totalsal == null ? 0L : (long)m.totalsal),
                    UnpaidDays = m.UnpaidDays
                }).ToList(); // materialize to avoid deferred issues

                var ds = new ReportDataSource("Salary", projected);
                reportViewer1.LocalReport.DataSources.Clear();
                reportViewer1.LocalReport.DataSources.Add(ds);

                var rp = new ReportParameter("DateTimeNowRp", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"));
                reportViewer1.LocalReport.SetParameters(rp);

                // Force processing so Render() has data
                reportViewer1.RefreshReport();

                // Ask user where to save PDF
                using (var sfd = new SaveFileDialog { Filter = "PDF File|*.pdf", FileName = "EmployeeReport_" + DateTime.Now.ToString("yyyyMMdd_HHmm") + ".pdf" })
                {
                    if (sfd.ShowDialog(this) == DialogResult.OK)
                    {
                        string mimeType, encoding, extension;
                        string[] streamIds; Warning[] warnings;
                        byte[] pdfBytes = reportViewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);
                        File.WriteAllBytes(sfd.FileName, pdfBytes);
                        MessageBox.Show("PDF exported to:\n" + sfd.FileName, "Export", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            } catch (Exception ex)
            {
                MessageBox.Show("Report error: " + ex.Message + (ex.InnerException != null ? "\nInner: " + ex.InnerException.Message : ""), "Report", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnChart_Click(object sender, EventArgs e) {
            using (var chartForm = new StatisticsChartForm())
            {
                chartForm.ShowDialog(this);
            }
        }

        private void rdoAllDay_CheckedChanged(object sender, EventArgs e) {
            bool enableRange = !rdoAllDay.Checked;
            dtpkFrom.Enabled = enableRange;
            dtpkTo.Enabled = enableRange;
        }
        private void label3_Click(object sender, EventArgs e) {
        }
        private void cbbFullName_SelectedIndexChanged(object sender, EventArgs e) {
        }
        private void cbbEmpID_SelectedIndexChanged(object sender, EventArgs e) {
        }
    }
}
