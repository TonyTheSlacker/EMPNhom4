using System;
using System.Drawing;
using System.Drawing.Printing;
using System.IO;
using System.Linq;
using System.Windows.Forms;

namespace EmployeeManagementSystem {
    public partial class StatisticsChartForm : Form {
        private readonly EmployeeDataContext db = new EmployeeDataContext();
        private Bitmap _printBitmap;
        private decimal maxValue;
        private System.Collections.Generic.List<(string Label, decimal Value)> currentData;
        public StatisticsChartForm() {
            InitializeComponent();
        }
        private void StatisticsChartForm_Load(object sender, EventArgs e) {
            this.WindowState = FormWindowState.Maximized;
            lblTitle.Text = "Statistics & Charts";
            cboMode.SelectedIndex = 0;
            LoadEmployees();
            UpdateControlVisibility();
            LoadAndBind();
        }
        private void cboMode_SelectedIndexChanged(object sender, EventArgs e) {
            UpdateControlVisibility();
            LoadAndBind();
        }
        private void cboEmployee_SelectedIndexChanged(object sender, EventArgs e) {
            if (cboMode.SelectedIndex == 2)
                LoadAndBind();
        }
        private void chkRange_CheckedChanged(object sender, EventArgs e) {
            UpdateControlVisibility();
            LoadAndBind();
        }
        private void dtFrom_ValueChanged(object sender, EventArgs e) {
            if (cboMode.SelectedIndex == 2)
                LoadAndBind();
        }
        private void dtTo_ValueChanged(object sender, EventArgs e) {
            if (cboMode.SelectedIndex == 2)
                LoadAndBind();
        }
        private void canvas_Resize(object sender, EventArgs e) {
            canvas.Invalidate();
        }
        private void canvas_Paint(object sender, PaintEventArgs e) {
            DrawChart(e.Graphics);
        }

        private void LoadEmployees() {
            try
            {
                var list = db.Employees.OrderBy(e => e.EmpName).Select(e => new { e.EmpID, e.EmpName }).ToList();
                cboEmployee.Items.Clear();
                cboEmployee.Items.Add("(Select Employee)");
                foreach (var emp in list)
                    cboEmployee.Items.Add(emp.EmpID + " - " + emp.EmpName);
                if (list.Count > 0)
                    cboEmployee.SelectedIndex = 1;
                else
                    cboEmployee.SelectedIndex = 0;
            } catch { }
        }
        private int? SelectedEmployeeId() {
            if (cboEmployee.SelectedIndex <= 0)
                return null;
            var text = cboEmployee.SelectedItem.ToString();
            int dash = text.IndexOf('-');
            if (dash > 0)
            {
                int id;
                if (int.TryParse(text.Substring(0, dash).Trim(), out id))
                    return id;
            }
            return null;
        }
        private void UpdateControlVisibility() {
            bool showEmp = (cboMode.SelectedIndex == 2);
            lblEmp.Visible = showEmp;
            cboEmployee.Visible = showEmp;
            chkRange.Visible = showEmp;
            bool showRange = showEmp && chkRange.Checked;
            lblFrom.Visible = showRange;
            dtFrom.Visible = showRange;
            lblTo.Visible = showRange;
            dtTo.Visible = showRange;
        }
        private void LoadAndBind() {
            try
            {
                if (cboMode.SelectedIndex == 0)
                {
                    lblTitle.Text = "Salary by Department";
                    currentData = db.Salaries.Select(s => new { Dept = s.Employee.EmpDep, s.totalsal })
                    .ToList().GroupBy(x => x.Dept)
                    .Select(g => (Label: db.Departments.Where(d => d.DepId == g.Key).Select(d => d.DepName).FirstOrDefault() ?? ("Dept " + g.Key), Value: g.Sum(z => (decimal)z.totalsal)))
                    .OrderByDescending(x => x.Value).ToList();
                } else if (cboMode.SelectedIndex == 1)
                {
                    lblTitle.Text = "Total Salary by Month";
                    currentData = db.Salaries.Select(s => new { s.Paydate, s.totalsal })
                    .ToList().GroupBy(x => new { x.Paydate.Year, x.Paydate.Month })
                    .Select(g => (Label: new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MM/yyyy"), Value: g.Sum(z => (decimal)z.totalsal)))
                    .OrderBy(x => DateTime.Parse("01/" + x.Label)).ToList();
                } else
                {
                    lblTitle.Text = "Employee Earnings by Month";
                    int? empId = SelectedEmployeeId();
                    var query = db.Salaries.AsQueryable();
                    if (empId.HasValue)
                        query = query.Where(s => s.Employee.EmpID == empId.Value);
                    if (chkRange.Checked)
                    {
                        var f = dtFrom.Value.Date;
                        var t = dtTo.Value.Date;
                        query = query.Where(s => s.Paydate.Date >= f && s.Paydate.Date <= t);
                    }
                    currentData = query.Select(s => new { s.Paydate, s.totalsal }).ToList()
                    .GroupBy(x => new { x.Paydate.Year, x.Paydate.Month })
                    .Select(g => (Label: new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MM/yyyy"), Value: g.Sum(z => (decimal)z.totalsal)))
                    .OrderBy(x => DateTime.Parse("01/" + x.Label)).ToList();
                }
                maxValue = currentData.Count > 0 ? currentData.Max(d => d.Value) : 1m;
                canvas.Invalidate();
            } catch (Exception ex) { MessageBox.Show("Failed to load chart data: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }
        private void DrawChart(Graphics g) {
            g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            var rect = canvas.ClientRectangle;
            rect.Inflate(-40, -50);
            if (rect.Width <= 0 || rect.Height <= 0)
                return;
            using (var bg = new SolidBrush(Color.White))
                g.FillRectangle(bg, canvas.ClientRectangle);
            using (var axis = new Pen(Color.Gray, 1))
            {
                g.DrawLine(axis, rect.Left, rect.Bottom, rect.Right, rect.Bottom);
                g.DrawLine(axis, rect.Left, rect.Bottom, rect.Left, rect.Top);
            }
            if (currentData == null || currentData.Count == 0)
            {
                using (var f = new Font("Century Gothic", 11, FontStyle.Italic))
                using (var b = new SolidBrush(Color.Gray))
                {
                    var s = g.MeasureString("No data", f);
                    g.DrawString("No data", f, b, rect.Left + (rect.Width - s.Width) / 2, rect.Top + (rect.Height - s.Height) / 2);
                }
                return;
            }
            if (cboMode.SelectedIndex == 0)
                DrawBars(g, rect);
            else
                DrawLine(g, rect);
        }
        private void DrawBars(Graphics g, Rectangle rect) {
            int n = currentData.Count;
            int spacing = 10;
            int barWidth = Math.Max(14, (rect.Width - spacing * (n + 1)) / Math.Max(1, n));
            using (var br = new SolidBrush(Color.SteelBlue))
            using (var txt = new SolidBrush(Color.Black))
            using (var small = new Font("Century Gothic", 8f))
            using (var grid = new Pen(Color.Gainsboro, 1))
            {
                for (int i = 1; i <= 5; i++)
                {
                    float y = rect.Bottom - i * (rect.Height / 5f);
                    g.DrawLine(grid, rect.Left, y, rect.Right, y);
                    string tick = string.Format("{0:N0}", (maxValue / 5m) * i);
                    var sz = g.MeasureString(tick, small);
                    g.DrawString(tick, small, txt, rect.Left - sz.Width - 8, y - sz.Height / 2f);
                }
                int x = rect.Left + spacing;
                for (int i = 0; i < n; i++)
                {
                    var d = currentData[i];
                    int h = (int)Math.Round((double)(d.Value / maxValue * rect.Height));
                    var bar = new Rectangle(x, rect.Bottom - h, barWidth, h);
                    g.FillRectangle(br, bar);
                    string val = string.Format("{0:N0}", d.Value);
                    var vs = g.MeasureString(val, small);
                    g.DrawString(val, small, txt, bar.Left + (bar.Width - vs.Width) / 2f, bar.Top - vs.Height - 2);
                    var xs = g.MeasureString(d.Label, small);
                    if (xs.Width > barWidth + 12)
                    {
                        var st = g.Save();
                        g.TranslateTransform(bar.Left + bar.Width / 2f, rect.Bottom + 6);
                        g.RotateTransform(-45);
                        g.DrawString(d.Label, small, txt, -xs.Width / 2f, 0);
                        g.Restore(st);
                    } else
                    {
                        g.DrawString(d.Label, small, txt, bar.Left + (bar.Width - xs.Width) / 2f, rect.Bottom + 6);
                    }
                    x += barWidth + spacing;
                }
            }
        }
        private void DrawLine(Graphics g, Rectangle rect) {
            int n = currentData.Count;
            var pts = new System.Collections.Generic.List<PointF>(n);
            for (int i = 0; i < n; i++)
            {
                float t = n == 1 ? 0.5f : (float)i / (n - 1);
                float x = rect.Left + t * rect.Width;
                float y = rect.Bottom - (float)((double)(currentData[i].Value / maxValue) * rect.Height);
                pts.Add(new PointF(x, y));
            }
            using (var grid = new Pen(Color.Gainsboro, 1))
            using (var line = new Pen(Color.SteelBlue, 2.5f))
            using (var marker = new SolidBrush(Color.SteelBlue))
            using (var txt = new SolidBrush(Color.Black))
            using (var small = new Font("Century Gothic", 8f))
            {
                for (int i = 1; i <= 5; i++)
                {
                    float y = rect.Bottom - i * (rect.Height / 5f);
                    g.DrawLine(grid, rect.Left, y, rect.Right, y);
                    string tick = string.Format("{0:N0}", (maxValue / 5m) * i);
                    var sz = g.MeasureString(tick, small);
                    g.DrawString(tick, small, txt, rect.Left - sz.Width - 8, y - sz.Height / 2f);
                }
                if (pts.Count >= 2)
                    g.DrawLines(line, pts.ToArray());
                for (int i = 0; i < n; i++)
                {
                    var p = pts[i];
                    g.FillEllipse(marker, p.X - 3, p.Y - 3, 6, 6);
                    string v = string.Format("{0:N0}", currentData[i].Value);
                    var vs = g.MeasureString(v, small);
                    g.DrawString(v, small, txt, p.X - vs.Width / 2f, p.Y - vs.Height - 4);
                    var xs = g.MeasureString(currentData[i].Label, small);
                    g.DrawString(currentData[i].Label, small, txt, p.X - xs.Width / 2f, rect.Bottom + 6);
                }
            }
        }
        private Bitmap CreateChartBitmap() {
            int w = Math.Max(64, canvas.Width);
            int h = Math.Max(64, canvas.Height);
            var bmp = new Bitmap(w, h);
            canvas.DrawToBitmap(bmp, new Rectangle(0, 0, w, h));
            return bmp;
        }
        private void btnExportImage_Click(object sender, EventArgs e) {
            try
            {
                using (var bmp = CreateChartBitmap())
                using (var sfd = new SaveFileDialog { Filter = "PNG Image|*.png|JPEG Image|*.jpg;*.jpeg|Bitmap Image|*.bmp", FileName = (string.IsNullOrWhiteSpace(lblTitle.Text) ? "Chart" : lblTitle.Text.Replace(' ', '_')) + "_" + DateTime.Now.ToString("yyyyMMdd_HHmm") })
                {
                    if (sfd.ShowDialog(this) == DialogResult.OK)
                    {
                        var ext = Path.GetExtension(sfd.FileName);
                        System.Drawing.Imaging.ImageFormat fmt = System.Drawing.Imaging.ImageFormat.Png;
                        if (!string.IsNullOrEmpty(ext))
                        {
                            switch (ext.ToLowerInvariant())
                            {
                                case ".jpg":
                                case ".jpeg":
                                    fmt = System.Drawing.Imaging.ImageFormat.Jpeg;
                                    break;
                                case ".bmp":
                                    fmt = System.Drawing.Imaging.ImageFormat.Bmp;
                                    break;
                                default:
                                    fmt = System.Drawing.Imaging.ImageFormat.Png;
                                    break;
                            }
                        } else
                        {
                            sfd.FileName = sfd.FileName + ".png";
                        }
                        bmp.Save(sfd.FileName, fmt);
                        MessageBox.Show("Chart image saved to:\n" + sfd.FileName, "Export", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            } catch (Exception ex) { MessageBox.Show("Failed to export image: " + ex.Message, "Export", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }
        private void btnPrint_Click(object sender, EventArgs e) {
            try
            {
                if (_printBitmap != null)
                {
                    _printBitmap.Dispose();
                    _printBitmap = null;
                }
                _printBitmap = CreateChartBitmap();
                PrintDocument pd = new PrintDocument { DocumentName = "Statistics Chart" };
                pd.PrintPage += (s, args) => { if (_printBitmap == null) return; Rectangle m = args.MarginBounds; float scale = Math.Min((float)m.Width / _printBitmap.Width, (float)m.Height / _printBitmap.Height); int w = (int)(_printBitmap.Width * scale); int h = (int)(_printBitmap.Height * scale); int x = m.Left + (m.Width - w) / 2; int y = m.Top + (m.Height - h) / 2; args.Graphics.DrawImage(_printBitmap, new Rectangle(x, y, w, h)); args.HasMorePages = false; };
                pd.EndPrint += (s, args) => { if (_printBitmap != null) { _printBitmap.Dispose(); _printBitmap = null; } };
                using (var preview = new PrintPreviewDialog { Document = pd, Width = 1000, Height = 800 })
                {
                    preview.ShowDialog(this);
                }
            } catch (Exception ex) { MessageBox.Show("Failed to print chart: " + ex.Message, "Print", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }
    }
}
