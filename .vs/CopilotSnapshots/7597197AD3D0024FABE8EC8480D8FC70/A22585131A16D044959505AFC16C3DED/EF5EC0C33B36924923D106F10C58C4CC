using System;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Windows.Forms;

namespace EmployeeManagementSystem {
    public partial class StatisticsChartForm : Form {
        private readonly EmployeeDataContext db = new EmployeeDataContext();
        private decimal maxValue;
        private System.Collections.Generic.List<(string Label, decimal Value)> currentData;
        public StatisticsChartForm() { InitializeComponent(); }
        private void StatisticsChartForm_Load(object sender, EventArgs e) { this.WindowState = FormWindowState.Maximized; lblTitle.Text = "Statistics & Charts"; cboMode.SelectedIndex = 0; LoadEmployees(); UpdateControlVisibility(); LoadAndBind(); }
        private void cboMode_SelectedIndexChanged(object sender, EventArgs e) { UpdateControlVisibility(); LoadAndBind(); }
        private void cboEmployee_SelectedIndexChanged(object sender, EventArgs e) { if (cboMode.SelectedIndex == 2) LoadAndBind(); }
        private void chkRange_CheckedChanged(object sender, EventArgs e) { UpdateControlVisibility(); LoadAndBind(); }
        private void dtFrom_ValueChanged(object sender, EventArgs e) { if (cboMode.SelectedIndex == 2) LoadAndBind(); }
        private void dtTo_ValueChanged(object sender, EventArgs e) { if (cboMode.SelectedIndex == 2) LoadAndBind(); }
        private void canvas_Resize(object sender, EventArgs e) { canvas.Invalidate(); }
        private void canvas_Paint(object sender, PaintEventArgs e) { DrawChart(e.Graphics); }

        private void LoadEmployees() {
            try {
                var list = db.Employees.OrderBy(e => e.EmpName).Select(e => new { e.EmpID, e.EmpName }).ToList();
                cboEmployee.Items.Clear();
                cboEmployee.Items.Add("(Select Employee)");
                foreach (var emp in list)
                    cboEmployee.Items.Add(emp.EmpID + " - " + emp.EmpName);
                cboEmployee.SelectedIndex = list.Count > 0 ? 1 : 0;
            } catch { }
        }
        private int? SelectedEmployeeId() {
            if (cboEmployee.SelectedIndex <= 0) return null;
            var text = cboEmployee.SelectedItem.ToString();
            int dash = text.IndexOf('-');
            if (dash > 0) {
                int id; if (int.TryParse(text.Substring(0, dash).Trim(), out id)) return id;
            }
            return null;
        }
        private string SelectedEmployeeName() {
            if (cboEmployee.SelectedIndex <= 0) return null;
            var text = cboEmployee.SelectedItem.ToString();
            int dash = text.IndexOf('-');
            if (dash > 0 && dash + 1 < text.Length)
                return text.Substring(dash + 1).Trim();
            return null;
        }
        private void UpdateControlVisibility() {
            bool showEmp = (cboMode.SelectedIndex == 2);
            lblEmp.Visible = showEmp;
            cboEmployee.Visible = showEmp;
            chkRange.Visible = showEmp;
            bool showRange = showEmp && chkRange.Checked;
            lblFrom.Visible = showRange;
            dtFrom.Visible = showRange;
            lblTo.Visible = showRange;
            dtTo.Visible = showRange;
        }
        private void LoadAndBind() {
            try {
                if (cboMode.SelectedIndex == 0) {
                    lblTitle.Text = "Salary by Department";
                    currentData = db.Salaries.Select(s => new { Dept = s.Employee.EmpDep, s.totalsal })
                        .ToList().GroupBy(x => x.Dept)
                        .Select(g => (Label: db.Departments.Where(d => d.DepId == g.Key).Select(d => d.DepName).FirstOrDefault() ?? ("Dept " + g.Key), Value: g.Sum(z => (decimal)z.totalsal)))
                        .OrderByDescending(x => x.Value).ToList();
                } else if (cboMode.SelectedIndex == 1) {
                    lblTitle.Text = "Total Salary by Month";
                    currentData = db.Salaries.Select(s => new { s.Paydate, s.totalsal })
                        .ToList().GroupBy(x => new { x.Paydate.Year, x.Paydate.Month })
                        .Select(g => (Label: new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MM/yyyy"), Value: g.Sum(z => (decimal)z.totalsal)))
                        .OrderBy(x => DateTime.Parse("01/" + x.Label)).ToList();
                } else {
                    lblTitle.Text = "Employee Earnings by Month";
                    int? empId = SelectedEmployeeId();
                    var query = db.Salaries.AsQueryable();
                    if (empId.HasValue) query = query.Where(s => s.Employee.EmpID == empId.Value);
                    if (chkRange.Checked) {
                        var f = dtFrom.Value.Date; var t = dtTo.Value.Date;
                        query = query.Where(s => s.Paydate.Date >= f && s.Paydate.Date <= t);
                    }
                    currentData = query.Select(s => new { s.Paydate, s.totalsal }).ToList()
                        .GroupBy(x => new { x.Paydate.Year, x.Paydate.Month })
                        .Select(g => (Label: new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MM/yyyy"), Value: g.Sum(z => (decimal)z.totalsal)))
                        .OrderBy(x => DateTime.Parse("01/" + x.Label)).ToList();
                }
                maxValue = currentData.Count > 0 ? currentData.Max(d => d.Value) : 1m;
                canvas.Invalidate();
            } catch (Exception ex) { MessageBox.Show("Failed to load chart data: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }
        private void DrawChart(Graphics g) {
            g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            var rect = canvas.ClientRectangle;
            rect.Inflate(-40, -50);
            if (rect.Width <= 0 || rect.Height <= 0) return;
            using (var bg = new SolidBrush(Color.White)) g.FillRectangle(bg, canvas.ClientRectangle);
            using (var axis = new Pen(Color.Gray, 1)) {
                g.DrawLine(axis, rect.Left, rect.Bottom, rect.Right, rect.Bottom);
                g.DrawLine(axis, rect.Left, rect.Bottom, rect.Left, rect.Top);
            }
            if (currentData == null || currentData.Count == 0) {
                using (var f = new Font("Century Gothic", 11, FontStyle.Italic))
                using (var b = new SolidBrush(Color.Gray)) {
                    var s = g.MeasureString("No data", f);
                    g.DrawString("No data", f, b, rect.Left + (rect.Width - s.Width) / 2, rect.Top + (rect.Height - s.Height) / 2);
                }
                return;
            }
            if (cboMode.SelectedIndex == 0) DrawBars(g, rect); else DrawLine(g, rect);
        }
        private void DrawBars(Graphics g, Rectangle rect) {
            int n = currentData.Count;
            int spacing = 10;
            int barWidth = Math.Max(14, (rect.Width - spacing * (n + 1)) / Math.Max(1, n));
            using (var br = new SolidBrush(Color.SteelBlue))
            using (var txt = new SolidBrush(Color.Black))
            using (var small = new Font("Century Gothic", 8f))
            using (var grid = new Pen(Color.Gainsboro, 1)) {
                for (int i = 1; i <= 5; i++) {
                    float y = rect.Bottom - i * (rect.Height / 5f);
                    g.DrawLine(grid, rect.Left, y, rect.Right, y);
                    string tick = string.Format("{0:N0}", (maxValue / 5m) * i);
                    var sz = g.MeasureString(tick, small);
                    g.DrawString(tick, small, txt, rect.Left - sz.Width - 8, y - sz.Height / 2f);
                }
                int x = rect.Left + spacing;
                for (int i = 0; i < n; i++) {
                    var d = currentData[i];
                    int h = (int)Math.Round((double)(d.Value / maxValue * rect.Height));
                    var bar = new Rectangle(x, rect.Bottom - h, barWidth, h);
                    g.FillRectangle(br, bar);
                    string val = string.Format("{0:N0}", d.Value);
                    var vs = g.MeasureString(val, small);
                    g.DrawString(val, small, txt, bar.Left + (bar.Width - vs.Width) / 2f, bar.Top - vs.Height - 2);
                    var xs = g.MeasureString(d.Label, small);
                    if (xs.Width > barWidth + 12) {
                        var st = g.Save();
                        g.TranslateTransform(bar.Left + bar.Width / 2f, rect.Bottom + 6);
                        g.RotateTransform(-45);
                        g.DrawString(d.Label, small, txt, -xs.Width / 2f, 0);
                        g.Restore(st);
                    } else {
                        g.DrawString(d.Label, small, txt, bar.Left + (bar.Width - xs.Width) / 2f, rect.Bottom + 6);
                    }
                    x += barWidth + spacing;
                }
            }
        }
        private void DrawLine(Graphics g, Rectangle rect) {
            int n = currentData.Count;
            var pts = new System.Collections.Generic.List<PointF>(n);
            for (int i = 0; i < n; i++) {
                float t = n == 1 ? 0.5f : (float)i / (n - 1);
                float x = rect.Left + t * rect.Width;
                float y = rect.Bottom - (float)((double)(currentData[i].Value / maxValue) * rect.Height);
                pts.Add(new PointF(x, y));
            }
            using (var grid = new Pen(Color.Gainsboro, 1))
            using (var line = new Pen(Color.SteelBlue, 2.5f))
            using (var marker = new SolidBrush(Color.SteelBlue))
            using (var txt = new SolidBrush(Color.Black))
            using (var small = new Font("Century Gothic", 8f)) {
                for (int i = 1; i <= 5; i++) {
                    float y = rect.Bottom - i * (rect.Height / 5f);
                    g.DrawLine(grid, rect.Left, y, rect.Right, y);
                    string tick = string.Format("{0:N0}", (maxValue / 5m) * i);
                    var sz = g.MeasureString(tick, small);
                    g.DrawString(tick, small, txt, rect.Left - sz.Width - 8, y - sz.Height / 2f);
                }
                if (pts.Count >= 2) g.DrawLines(line, pts.ToArray());
                for (int i = 0; i < n; i++) {
                    var p = pts[i];
                    g.FillEllipse(marker, p.X - 3, p.Y - 3, 6, 6);
                    string v = string.Format("{0:N0}", currentData[i].Value);
                    var vs = g.MeasureString(v, small);
                    g.DrawString(v, small, txt, p.X - vs.Width / 2f, p.Y - vs.Height - 4);
                    var xs = g.MeasureString(currentData[i].Label, small);
                    g.DrawString(currentData[i].Label, small, txt, p.X - xs.Width / 2f, rect.Bottom + 6);
                }
            }
        }
        private Bitmap CreateChartBitmap() {
            int w = Math.Max(64, canvas.Width);
            int h = Math.Max(64, canvas.Height);
            var bmp = new Bitmap(w, h);
            canvas.DrawToBitmap(bmp, new Rectangle(0, 0, w, h));
            return bmp;
        }
        private void btnExportImage_Click(object sender, EventArgs e) {
            try {
                using (var bmp = CreateChartBitmap())
                using (var sfd = new SaveFileDialog { Filter = "PNG Image|*.png|JPEG Image|*.jpg;*.jpeg|Bitmap Image|*.bmp", FileName = BuildBaseFileName() }) {
                    if (sfd.ShowDialog(this) == DialogResult.OK) {
                        var ext = Path.GetExtension(sfd.FileName);
                        System.Drawing.Imaging.ImageFormat fmt = System.Drawing.Imaging.ImageFormat.Png;
                        if (!string.IsNullOrEmpty(ext)) {
                            switch (ext.ToLowerInvariant()) {
                                case ".jpg":
                                case ".jpeg": fmt = System.Drawing.Imaging.ImageFormat.Jpeg; break;
                                case ".bmp": fmt = System.Drawing.Imaging.ImageFormat.Bmp; break;
                                default: fmt = System.Drawing.Imaging.ImageFormat.Png; break;
                            }
                        } else {
                            sfd.FileName = sfd.FileName + ".png";
                        }
                        bmp.Save(sfd.FileName, fmt);
                        MessageBox.Show("Chart image saved to:\n" + sfd.FileName, "Export", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            } catch (Exception ex) { MessageBox.Show("Failed to export image: " + ex.Message, "Export", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }

        private string BuildBaseFileName() {
            string baseTitle = string.IsNullOrWhiteSpace(lblTitle.Text) ? "Chart" : lblTitle.Text.Replace(' ', '_');
            if (cboMode.SelectedIndex == 2) {
                var id = SelectedEmployeeId(); var name = SelectedEmployeeName();
                if (id.HasValue && !string.IsNullOrEmpty(name)) baseTitle = "Employee_" + id.Value + "_" + name.Replace(' ', '_');
            }
            return baseTitle + "_" + DateTime.Now.ToString("yyyyMMdd_HHmm");
        }

        private void btnPrint_Click(object sender, EventArgs e) {
            try {
                using (var bmp = CreateChartBitmap())
                using (var sfd = new SaveFileDialog { Filter = "PDF File|*.pdf", FileName = BuildBaseFileName() + ".pdf" }) {
                    if (sfd.ShowDialog(this) == DialogResult.OK) {
                        byte[] jpgBytes;
                        using (var ms = new MemoryStream()) { bmp.Save(ms, System.Drawing.Imaging.ImageFormat.Jpeg); jpgBytes = ms.ToArray(); }
                        int imgWpt = (int)(bmp.Width * 72.0 / bmp.HorizontalResolution);
                        int imgHpt = (int)(bmp.Height * 72.0 / bmp.VerticalResolution);
                        int pageW = Math.Max(imgWpt + 40, 595);
                        int pageH = Math.Max(imgHpt + 80, 842);
                        int imgX = (pageW - imgWpt) / 2;
                        int imgY = (pageH - imgHpt) / 2;
                        using (var fs = new FileStream(sfd.FileName, FileMode.Create, FileAccess.Write))
                        using (var bw = new BinaryWriter(fs)) {
                            bw.Write(System.Text.Encoding.ASCII.GetBytes("%PDF-1.4\n"));
                            var offsets = new System.Collections.Generic.List<long>();
                            Action<string> writeObj = (s) => { offsets.Add(fs.Position); bw.Write(System.Text.Encoding.ASCII.GetBytes(s)); };
                            writeObj("1 0 obj<< /Type /Catalog /Pages 2 0 R >>endobj\n");
                            writeObj("2 0 obj<< /Type /Pages /Kids [3 0 R] /Count 1 >>endobj\n");
                            // Correct page dictionary (removed duplicate >>)
                            writeObj(string.Format("3 0 obj<< /Type /Page /Parent 2 0 R /MediaBox [0 0 {0} {1}] /Resources << /XObject << /Im0 4 0 R >> /ProcSet [/PDF /ImageC] >> /Contents 5 0 R >>endobj\n", pageW, pageH));
                            writeObj(string.Format("4 0 obj<< /Type /XObject /Subtype /Image /Width {0} /Height {1} /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length {2} >>stream\n", bmp.Width, bmp.Height, jpgBytes.Length));
                            bw.Write(jpgBytes);
                            bw.Write(System.Text.Encoding.ASCII.GetBytes("\nendstream\nendobj\n"));
                            string content = string.Format("q\n{0} 0 0 {1} {2} {3} cm /Im0 Do\nQ\n", imgWpt, imgHpt, imgX, imgY);
                            writeObj(string.Format("5 0 obj<< /Length {0} >>stream\n{1}endstream\nendobj\n", content.Length, content));
                            long xrefPos = fs.Position;
                            bw.Write(System.Text.Encoding.ASCII.GetBytes("xref\n0 6\n0000000000 65535 f \n"));
                            for (int i = 0; i < offsets.Count; i++)
                                bw.Write(System.Text.Encoding.ASCII.GetBytes(offsets[i].ToString("D10") + " 00000 n \n"));
                            bw.Write(System.Text.Encoding.ASCII.GetBytes("trailer<< /Size 6 /Root 1 0 R >>\nstartxref\n" + xrefPos + "\n%%EOF\n"));
                        }
                        MessageBox.Show("PDF exported to:\n" + sfd.FileName, "Export", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            } catch (Exception ex) { MessageBox.Show("Failed to export PDF: " + ex.Message, "Export", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }
    }
}
