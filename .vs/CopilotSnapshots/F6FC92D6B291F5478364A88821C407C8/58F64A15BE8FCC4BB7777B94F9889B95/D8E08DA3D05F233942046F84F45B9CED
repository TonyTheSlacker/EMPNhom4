using System;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;
using System.Windows.Forms.DataVisualization.Charting;

namespace QLNHANVIENFULL
{
 public partial class StatisticsChartForm : Form
 {
 private readonly EmployeeDataContext db = new EmployeeDataContext();

 public StatisticsChartForm()
 {
 InitializeComponent();
 }

 private void StatisticsChartForm_Load(object sender, EventArgs e)
 {
 cboMode.SelectedIndex =0;
 LoadAndBind();
 }

 private void cboMode_SelectedIndexChanged(object sender, EventArgs e)
 {
 LoadAndBind();
 }

 private void LoadAndBind()
 {
 try
 {
 chartMain.Series.Clear();
 chartMain.ChartAreas[0].AxisX.Interval =1;
 chartMain.ChartAreas[0].AxisX.LabelStyle.Angle =0;
 chartMain.ChartAreas[0].AxisX.MajorGrid.Enabled = false;
 chartMain.ChartAreas[0].AxisY.MajorGrid.LineColor = Color.LightGray;

 if (cboMode.SelectedIndex ==0)
 {
 lblTitle.Text = "Salary by Department";
 var data = db.Salaries
 .Select(s => new { DeptId = s.Employee.EmpDep, s.totalsal })
 .ToList()
 .GroupBy(x => x.DeptId)
 .Select(g => new
 {
 DeptName = db.Departments.Where(d => d.DepId == g.Key).Select(d => d.DepName).FirstOrDefault() ?? ("Dept " + g.Key),
 Total = g.Sum(z => (decimal)z.totalsal)
 })
 .OrderByDescending(x => x.Total)
 .ToList();

 var series = new Series("Departments") { ChartType = SeriesChartType.Column, IsValueShownAsLabel = true };
 foreach (var item in data)
 {
 int pointIndex = series.Points.AddXY(item.DeptName, item.Total);
 series.Points[pointIndex].LabelForeColor = Color.Black;
 }
 chartMain.Series.Add(series);
 }
 else
 {
 lblTitle.Text = "Total Salary by Month";
 var data = db.Salaries
 .Select(s => new { s.Paydate, s.totalsal })
 .ToList()
 .GroupBy(x => new { x.Paydate.Year, x.Paydate.Month })
 .Select(g => new
 {
 Month = new DateTime(g.Key.Year, g.Key.Month,1),
 Total = g.Sum(z => (decimal)z.totalsal)
 })
 .OrderBy(x => x.Month)
 .ToList();

 var series = new Series("Monthly") { ChartType = SeriesChartType.Line, BorderWidth =3, MarkerStyle = MarkerStyle.Circle, MarkerSize =7, IsValueShownAsLabel = true };
 foreach (var item in data)
 {
 int pointIndex = series.Points.AddXY(item.Month.ToString("MM/yyyy"), item.Total);
 series.Points[pointIndex].LabelForeColor = Color.Black;
 }
 chartMain.Series.Add(series);
 }
 }
 catch (Exception ex)
 {
 MessageBox.Show("Failed to load chart data: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
 }
 }

 private void btnRefresh_Click(object sender, EventArgs e)
 {
 LoadAndBind();
 }
 }
}
