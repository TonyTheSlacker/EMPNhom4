using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;

namespace QLNHANVIENFULL {
    // Designer-friendly, drawing charts with GDI+
    public partial class StatisticsChartForm : Form {
        private readonly EmployeeDataContext db = new EmployeeDataContext();

        private List<Tuple<string, decimal>> deptData = new List<Tuple<string, decimal>>();
        private List<Tuple<DateTime, decimal>> monthlyData = new List<Tuple<DateTime, decimal>>();

        public StatisticsChartForm() {
            InitializeComponent();
            SetStyle(ControlStyles.AllPaintingInWmPaint | ControlStyles.OptimizedDoubleBuffer | ControlStyles.UserPaint, true);
            DoubleBuffered = true;
            this.Load += (s, e) => RefreshDataAndRedraw();
            cboMode.SelectedIndexChanged += (s, e) => RefreshDataAndRedraw();
            canvas.Paint += Canvas_Paint; // ensure handler wired even if designer lost it
            canvas.Resize += (s, e) => canvas.Invalidate();
        }

        private void RefreshDataAndRedraw() {
            try
            {
                if (cboMode.SelectedIndex == 0)
                {
                    lblTitle.Text = "Salary by Department";
                    LoadDepartmentData();
                } else
                {
                    lblTitle.Text = "Total Salary by Month";
                    LoadMonthlyData();
                }
            } catch (Exception ex)
            {
                MessageBox.Show("Failed to load chart data: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            } finally
            {
                canvas.Invalidate();
            }
        }

        private void LoadDepartmentData() {
            // Sum totalsal by department
            // Use LINQ-To-SQL only for the base query and finish grouping in memory to avoid translation issues
            var q = db.Salaries.Select(s => new
            {
                DeptId = s.Employee.EmpDep,
                s.totalsal
            }).ToList();

            var depNames = db.Departments.Select(d => new { d.DepId, d.DepName }).ToList();
            var nameById = depNames.ToDictionary(d => d.DepId, d => d.DepName);

            deptData = q
                .GroupBy(x => x.DeptId)
                .Select(g => Tuple.Create(
                    nameById.ContainsKey(g.Key) ? nameById[g.Key] : ("Dept " + g.Key),
                    g.Sum(z => (decimal)z.totalsal)
                ))
                .OrderByDescending(x => x.Item2)
                .ToList();
        }

        private void LoadMonthlyData() {
            // Group by (Paydate.Year, Paydate.Month) and sum totalsal
            var raw = db.Salaries
                .Select(s => new { s.Paydate, s.totalsal })
                .ToList();

            monthlyData = raw
                .Select(x => Tuple.Create(new DateTime(x.Paydate.Year, x.Paydate.Month, 1), (decimal)x.totalsal))
                .GroupBy(x => x.Item1)
                .Select(g => Tuple.Create(g.Key, g.Sum(v => v.Item2)))
                .OrderBy(t => t.Item1)
                .ToList();
        }

        private void Canvas_Paint(object sender, PaintEventArgs e) {
            e.Graphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            var g = e.Graphics;
            var bounds = canvas.ClientRectangle;
            bounds.Inflate(-24, -24);
            if (bounds.Width <= 0 || bounds.Height <= 0)
                return;
            using (var bg = new SolidBrush(Color.White))
                g.FillRectangle(bg, canvas.ClientRectangle);
            var chartRect = Rectangle.FromLTRB(bounds.Left + 56, bounds.Top + 16, bounds.Right - 16, bounds.Bottom - 56);
            if (cboMode.SelectedIndex == 0)
                DrawBarChart(g, chartRect, deptData);
            else
                DrawLineChart(g, chartRect, monthlyData);
        }

        private void DrawAxes(Graphics g, Rectangle rect) {
            using (var axis = new Pen(Color.Gray, 1))
            {
                g.DrawLine(axis, rect.Left, rect.Bottom, rect.Right, rect.Bottom); // X
                g.DrawLine(axis, rect.Left, rect.Bottom, rect.Left, rect.Top); // Y
            }
        }

        private void DrawBarChart(Graphics g, Rectangle rect, List<Tuple<string, decimal>> data) {
            DrawAxes(g, rect);
            if (data == null || data.Count == 0)
            {
                DrawEmpty(g, rect, "No data");
                return;
            }
            decimal max = data.Max(d => d.Item2);
            if (max <= 0)
                max = 1;
            int n = data.Count;
            int spacing = 8;
            int barWidth = Math.Max(12, (rect.Width - spacing * (n + 1)) / Math.Max(1, n));
            var barColor = Color.FromArgb(255, 140, 0);
            using (var br = new SolidBrush(barColor))
            using (var lblBrush = new SolidBrush(Color.Black))
            using (var small = new Font("Segoe UI", 7f))
            using (var gridPen = new Pen(Color.Gainsboro, 1))
            {
                // horizontal grid lines (5)
                for (int i = 1; i <= 5; i++)
                {
                    float y = rect.Bottom - i * (rect.Height / 5f);
                    g.DrawLine(gridPen, rect.Left, y, rect.Right, y);
                    string tick = string.Format("{0:N0}", (max / 5m) * i);
                    var size = g.MeasureString(tick, small);
                    g.DrawString(tick, small, lblBrush, rect.Left - size.Width - 6, y - size.Height / 2f);
                }

                int x = rect.Left + spacing;
                for (int i = 0; i < n; i++)
                {
                    var d = data[i];
                    int h = (int)Math.Round((double)(d.Item2 / max * rect.Height));
                    var bar = new Rectangle(x, rect.Bottom - h, barWidth, h);
                    g.FillRectangle(br, bar);

                    // value label
                    string v = string.Format("{0:N0}", d.Item2);
                    var vsz = g.MeasureString(v, small);
                    g.DrawString(v, small, lblBrush, bar.Left + (bar.Width - vsz.Width) / 2f, bar.Top - vsz.Height - 2);

                    // x label rotated if crowded
                    string xlbl = d.Item1;
                    var xsz = g.MeasureString(xlbl, small);
                    if (xsz.Width > barWidth + 12)
                    {
                        // angled label
                        var state = g.Save();
                        g.TranslateTransform(bar.Left + bar.Width / 2f, rect.Bottom + 6);
                        g.RotateTransform(-45);
                        g.DrawString(xlbl, small, lblBrush, -xsz.Width / 2f, 0);
                        g.Restore(state);
                    } else
                    {
                        g.DrawString(xlbl, small, lblBrush, bar.Left + (bar.Width - xsz.Width) / 2f, rect.Bottom + 6);
                    }

                    x += barWidth + spacing;
                }
            }
        }

        private void DrawLineChart(Graphics g, Rectangle rect, List<Tuple<DateTime, decimal>> data) {
            DrawAxes(g, rect);
            if (data == null || data.Count == 0)
            {
                DrawEmpty(g, rect, "No data");
                return;
            }
            decimal max = data.Max(d => d.Item2);
            if (max <= 0)
                max = 1;
            int n = data.Count;

            var pts = new List<PointF>(n);
            for (int i = 0; i < n; i++)
            {
                float t = n == 1 ? 0.5f : (float)i / (n - 1);
                float x = rect.Left + t * rect.Width;
                float y = rect.Bottom - (float)((double)(data[i].Item2 / max) * rect.Height);
                pts.Add(new PointF(x, y));
            }

            using (var gridPen = new Pen(Color.Gainsboro, 1))
            using (var linePen = new Pen(Color.FromArgb(255, 140, 0), 2f))
            using (var markerBrush = new SolidBrush(Color.FromArgb(255, 140, 0)))
            using (var lblBrush = new SolidBrush(Color.Black))
            using (var small = new Font("Segoe UI", 7f))
            {
                // horizontal grid lines (5)
                for (int i = 1; i <= 5; i++)
                {
                    float y = rect.Bottom - i * (rect.Height / 5f);
                    g.DrawLine(gridPen, rect.Left, y, rect.Right, y);
                    string tick = string.Format("{0:N0}", (max / 5m) * i);
                    var size = g.MeasureString(tick, small);
                    g.DrawString(tick, small, lblBrush, rect.Left - size.Width - 6, y - size.Height / 2f);
                }

                // line
                if (pts.Count >= 2)
                    g.DrawLines(linePen, pts.ToArray());

                // markers and labels
                for (int i = 0; i < n; i++)
                {
                    var p = pts[i];
                    g.FillEllipse(markerBrush, p.X - 3, p.Y - 3, 6, 6);

                    string v = string.Format("{0:N0}", data[i].Item2);
                    var vsz = g.MeasureString(v, small);
                    g.DrawString(v, small, lblBrush, p.X - vsz.Width / 2f, p.Y - vsz.Height - 4);

                    string xl = data[i].Item1.ToString("MM/yyyy");
                    var xsz = g.MeasureString(xl, small);
                    g.DrawString(xl, small, lblBrush, p.X - xsz.Width / 2f, rect.Bottom + 6);
                }
            }
        }

        private void DrawEmpty(Graphics g, Rectangle rect, string message) {
            using (var f = new Font("Segoe UI", 9f, FontStyle.Italic))
            using (var b = new SolidBrush(Color.Gray))
            {
                var sz = g.MeasureString(message, f);
                g.DrawString(message, f, b, rect.Left + (rect.Width - sz.Width) / 2f, rect.Top + (rect.Height - sz.Height) / 2f);
            }
        }

        private void InitializeComponent() {
            this.SuspendLayout();
            // 
            // StatisticsChartForm
            // 
            this.ClientSize = new System.Drawing.Size(1474, 815);
            this.Name = "StatisticsChartForm";
            this.ResumeLayout(false);

        }
    }
}
