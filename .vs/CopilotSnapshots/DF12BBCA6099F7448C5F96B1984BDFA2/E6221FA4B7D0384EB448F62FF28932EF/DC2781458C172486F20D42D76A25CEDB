using System;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Windows.Forms;

namespace QLNHANVIENFULL {
    public partial class LoginForm : Form {
        EmployeeDataContext db = new EmployeeDataContext();
        public LoginForm() {
            InitializeComponent();
            txtusername.Text = "";
            txtpassword.Text = "";
            LoadRemembered();
        }

        private void chkshow_CheckedChanged(object sender, EventArgs e) {
            if (chkshow.Checked)
            {
                txtpassword.UseSystemPasswordChar = false;
            } else
            {
                txtpassword.UseSystemPasswordChar = true;
            }

        }

        private void pictureBox2_Click(object sender, EventArgs e) {
            Application.Exit();
        }

        private void label5_Click(object sender, EventArgs e) {
            txtpassword.ResetText();
            txtusername.ResetText();
        }

        private void Login_Click(object sender, EventArgs e) {

            string user = txtusername.Text.Trim();
            string password = txtpassword.Text.Trim();
            if (user == "" || password == "")
            {
                MessageBox.Show("Miss data");
                return;
            }
            Account account = db.Accounts.SingleOrDefault(p => p.username == user && p.password == Hashpassword(password));
            if (account == null)
            {
                lblCheck.Visible = true;
                lblCheck.Text = "Account not correct !";
            } else
            {
                // Remember credentials if asked
                if (chkRemember != null && chkRemember.Checked)
                {
                    RememberMeStore.Save(user, password);
                }
                else
                {
                    RememberMeStore.Clear();
                }

                txtpassword.ResetText();
                txtusername.ResetText();
                Form1 frm = new Form1();
                frm.ShowDialog();

                // when user comes back from main form (logout/close), prefill remembered
                LoadRemembered();
            }


        }

        private void txtusername_KeyPress(object sender, KeyPressEventArgs e) {
            lblCheck.Visible = false;
        }

        private void btnForget_Click(object sender, EventArgs e) {
            ForgetPasswordForm f = new ForgetPasswordForm();
            f.ShowDialog();
        }
        string Hashpassword(string pass) {
            using (MD5CryptoServiceProvider md5 = new MD5CryptoServiceProvider())
            {
                UTF8Encoding utf8 = new UTF8Encoding();
                byte[] data = md5.ComputeHash(utf8.GetBytes(pass));
                return Convert.ToBase64String(data);
            }
        }

        private void LoadRemembered()
        {
            string user, pass;
            if (RememberMeStore.TryLoad(out user, out pass))
            {
                txtusername.Text = user;
                txtpassword.Text = pass;
                if (chkRemember != null)
                    chkRemember.Checked = true;
                // keep masked unless user selects show
                txtpassword.UseSystemPasswordChar = !(chkshow != null && chkshow.Checked);
            }
        }
    }

    internal static class RememberMeStore
    {
        private static readonly string AppDir = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "QLNHANVIENFULL");
        private static readonly string FilePath = Path.Combine(AppDir, "remember.dat");
        private static readonly byte[] Entropy = Encoding.UTF8.GetBytes("QLNHANVIENFULL.Remember.v1");

        public static void Save(string user, string password)
        {
            Directory.CreateDirectory(AppDir);
            byte[] protectedPwd = ProtectedData.Protect(Encoding.UTF8.GetBytes(password), Entropy, DataProtectionScope.CurrentUser);
            string payload = user + "|" + Convert.ToBase64String(protectedPwd);
            File.WriteAllText(FilePath, payload, Encoding.UTF8);
        }

        public static bool TryLoad(out string user, out string password)
        {
            user = null; password = null;
            if (!File.Exists(FilePath)) return false;
            try
            {
                string text = File.ReadAllText(FilePath, Encoding.UTF8);
                string[] parts = text.Split(new[] { '|' },2);
                if (parts.Length !=2) return false;
                user = parts[0];
                byte[] protectedPwd = Convert.FromBase64String(parts[1]);
                byte[] bytes = ProtectedData.Unprotect(protectedPwd, Entropy, DataProtectionScope.CurrentUser);
                password = Encoding.UTF8.GetString(bytes);
                return true;
            }
            catch { return false; }
        }

        public static void Clear()
        {
            if (File.Exists(FilePath))
            {
                try { File.Delete(FilePath); } catch { }
            }
        }
    }
}
